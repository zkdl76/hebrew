<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Genesis Root Master</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<div id="statusBoard">
<div>STAGE: <span id="lvDisplay">1</span></div>
<div>POINTS: <span id="scoreDisplay">10</span></div>
<div>REMAIN: <span id="remainDisplay">0</span></div>
</div>

<div id="timerContainer">TIME: <span id="timeVal">10</span></div>
<div id="eventIndicator"></div>

<select id="chapterSelect"></select>
<button onclick="goStudy()">ğŸ“˜ í•™ìŠµí•˜ê¸°</button>

<div id="wordCanvas"></div>

<input id="answerInput" placeholder="ì–´ê·¼ ëœ» ì…ë ¥">
<br>
<button onclick="checkAnswer()">í™•ì¸</button>
<button onclick="buyHint()" id="hintBtn" style="display:none;">íŒíŠ¸ êµ¬ë§¤ (-5P)</button>

<div id="feedback"></div>

<div>
<h3>ì˜¤ë‹µ ë³´ê´€ì†Œ</h3>
<div id="wrongItems"></div>
</div>

<script src="data.js"></script>

<script>
let currentChapter = 1;
let currentVerbs = [];
let wrongAnswers = [];
let current = null;

let score = 10;
let unlockedStages = JSON.parse(localStorage.getItem("unlocked")) || [1];

let timeLeft = 10;
let timer = null;

// FIXED element references
const canvas = document.getElementById("wordCanvas");
const input = document.getElementById("answerInput");
const feedbackEl = document.getElementById("feedback");
const scoreDisp = document.getElementById("scoreDisplay");
const remainDisp = document.getElementById("remainDisplay");
const wrongDiv = document.getElementById("wrongItems");
const hintBtnEl = document.getElementById("hintBtn");
const timeDisp = document.getElementById("timeVal");
const eventInd = document.getElementById("eventIndicator");
const chapterSelect = document.getElementById("chapterSelect");

// Save unlock state
function saveUnlock(){
localStorage.setItem("unlocked", JSON.stringify(unlockedStages));
}

// Update dropdown
function updateDropdown(){
chapterSelect.innerHTML="";
Object.keys(bibleData).forEach(ch=>{

const opt=document.createElement("option");

opt.value=ch;

if(unlockedStages.includes(parseInt(ch))){
opt.textContent="ğŸ“– Genesis "+ch;
}else{
opt.textContent="ğŸ”’ Genesis "+ch;
opt.disabled=true;
}

chapterSelect.appendChild(opt);

});

chapterSelect.value=currentChapter;
}

// Load chapter
function loadChapter(ch){

currentChapter=parseInt(ch);

currentVerbs=[...bibleData[ch]];

wrongAnswers=[];

updateStatus();

nextQuestion();

}

// Update status
function updateStatus(){

scoreDisp.textContent=score;

remainDisp.textContent=currentVerbs.length;

wrongDiv.innerHTML=wrongAnswers.length===0
?"ì—†ìŒ"
:wrongAnswers.map(w=>"<span class='wrong-item'>"+w.form+"</span>").join("");

}

// Timer
function startTimer(){

clearInterval(timer);

timeLeft=10;

timeDisp.textContent=timeLeft;

timer=setInterval(()=>{

timeLeft--;

timeDisp.textContent=timeLeft;

if(timeLeft<=0){

clearInterval(timer);

timeout();

}

},1000);

}

// Timeout
function timeout(){
canvas.classList.remove("correct");
canvas.classList.add("wrong");
score -= 2;

if(score < 0){

alert("GAME OVER");

score = 10;

currentChapter = 1;

unlockedStages = [1];

saveUnlock();

updateDropdown();

loadChapter(1);

return;

}

feedbackEl.innerHTML =
"<span style='color:red;'>TIME OVER! -2P</span><br>ì •ë‹µ: "+current.root;

if(!wrongAnswers.find(v=>v.form===current.form)){

wrongAnswers.push(current);

}

updateStatus();

setTimeout(nextQuestion,2000);

}

// Next question
function nextQuestion(){
canvas.classList.remove("correct");
canvas.classList.remove("wrong");

let pool=[...currentVerbs,...wrongAnswers];

if(pool.length===0){
clearInterval(timer);   // âœ… ì´ ì¤„ ì¶”ê°€
canvas.textContent="CLEAR!";

const next=currentChapter+1;

if(bibleData[next] && !unlockedStages.includes(next)){

unlockedStages.push(next);

saveUnlock();

updateDropdown();

}

return;

}

// prevent same repeat
pool=pool.filter(v=>!current || v.form!==current.form);

if(pool.length===0){

pool=[...currentVerbs,...wrongAnswers];

}

current=pool[Math.floor(Math.random()*pool.length)];

canvas.textContent=current.form;

input.value="";

input.focus();

startTimer();

}

// Check answer
function checkAnswer(){

const val=input.value.trim();

if(!current) return;

if(val.includes(current.root)){
canvas.classList.remove("wrong");
canvas.classList.add("correct");
score+=10;
feedbackEl.innerHTML="<span style='color:lightgreen;'>ì •ë‹µ! +10P</span>";

currentVerbs=currentVerbs.filter(v=>v.form!==current.form);

wrongAnswers=wrongAnswers.filter(v=>v.form!==current.form);

}else{
canvas.classList.remove("wrong");
canvas.classList.add("correct");
score-=2;
feedbackEl.innerHTML="<span style='color:red;'>ì˜¤ë‹µ!</span> ì •ë‹µ: "+current.root;

if(!wrongAnswers.find(v=>v.form===current.form)){

wrongAnswers.push(current);

}

}

updateStatus();

setTimeout(nextQuestion,1000);

}

// Hint
function buyHint(){

if(score<5) return;

score-=5;

feedbackEl.innerHTML="<div class='hint-box'>íŒíŠ¸: "+current.root.charAt(0)+"...</div>";

updateStatus();

}

// Go study
function goStudy(){

location.href="study.html?ch="+currentChapter;

}

// Dropdown change
chapterSelect.addEventListener("change", function(){

loadChapter(this.value);

});

// Enter key support
input.addEventListener("keypress", function(e){

if(e.key==="Enter"){

checkAnswer();

}

});

// Init safely
window.onload=function(){

updateDropdown();

loadChapter(1);

};

</script>

</body>
</html>
