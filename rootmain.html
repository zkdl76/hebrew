<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Genesis Root Master</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ê°„ë‹¨í•œ ë ˆì´ì•„ì›ƒ ë³´ì • */
        body { background: #1a1a1a; color: white; text-align: center; font-family: sans-serif; }
        #wordCanvas { font-size: 80px; margin: 40px 0; min-height: 120px; transition: 0.3s; }
        .correct { color: #4CAF50; transform: scale(1.1); }
        .wrong { color: #f44336; animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        #statusBoard { display: flex; justify-content: space-around; padding: 20px; background: rgba(0,0,0,0.3); }
        .wrong-item { display: inline-block; margin: 5px; padding: 5px 10px; background: #444; border-radius: 5px; font-size: 14px; }
        #answerInput { font-size: 20px; padding: 10px; border-radius: 5px; border: none; width: 250px; text-align: center; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; border-radius: 5px; border: none; margin: 5px; }
        .btn-main { background: #4CAF50; color: white; }
        .btn-hint { background: #ff9800; color: white; }
    </style>
</head>
<body>

<div id="statusBoard">
    <div>STAGE: <span id="lvDisplay">1</span></div>
    <div>POINTS: <span id="scoreDisplay">10</span></div>
    <div>REMAIN: <span id="remainDisplay">0</span></div>
</div>

<div id="timerContainer" style="font-size: 24px; margin-top: 10px;">
    TIME: <span id="timeVal" style="color: #ffeb3b;">10</span>
</div>

<div id="wordCanvas">ì¤€ë¹„...</div>

<div style="margin-bottom: 20px;">
    <select id="chapterSelect" style="font-size: 18px; padding: 5px;"></select>
    <button onclick="goStudy()" class="btn-main">ğŸ“˜ í•™ìŠµí•˜ê¸°</button>
</div>

<input id="answerInput" placeholder="ì–´ê·¼(í•œê¸€) ì…ë ¥" autocomplete="off">
<br>
<button onclick="checkAnswer()" class="btn-main">í™•ì¸ (Enter)</button>
<button onclick="buyHint()" id="hintBtn" class="btn-hint" style="display:none;">íŒíŠ¸ êµ¬ë§¤ (-5P)</button>

<div id="feedback" style="height: 50px; margin-top: 10px; font-size: 20px;"></div>

<div style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
    <h3>ì˜¤ë‹µ ë³´ê´€ì†Œ</h3>
    <div id="wrongItems">ì—†ìŒ</div>
</div>

<script src="data.js"></script>
<script>
    let currentChapter = 1;
    let currentVerbs = [];
    let wrongAnswers = [];
    let current = null;
    let score = 10;
    let unlockedStages = JSON.parse(localStorage.getItem("unlocked")) || [1];
    let timeLeft = 10;
    let timer = null;
    let isProcessing = false; // ì¤‘ë³µ ì •ë‹µ ë°©ì§€ìš©

    const canvas = document.getElementById("wordCanvas");
    const input = document.getElementById("answerInput");
    const feedbackEl = document.getElementById("feedback");
    const scoreDisp = document.getElementById("scoreDisplay");
    const remainDisp = document.getElementById("remainDisplay");
    const wrongDiv = document.getElementById("wrongItems");
    const hintBtnEl = document.getElementById("hintBtn");
    const timeDisp = document.getElementById("timeVal");
    const chapterSelect = document.getElementById("chapterSelect");
    const lvDisplay = document.getElementById("lvDisplay");

    function saveUnlock() { localStorage.setItem("unlocked", JSON.stringify(unlockedStages)); }

    function updateDropdown() {
        chapterSelect.innerHTML = "";
        Object.keys(bibleData).forEach(ch => {
            const opt = document.createElement("option");
            opt.value = ch;
            const isUnlocked = unlockedStages.includes(parseInt(ch));
            opt.textContent = (isUnlocked ? "ğŸ“–" : "ğŸ”’") + " Genesis " + ch;
            opt.disabled = !isUnlocked;
            chapterSelect.appendChild(opt);
        });
        chapterSelect.value = currentChapter;
    }

    function loadChapter(ch) {
        currentChapter = parseInt(ch);
        lvDisplay.textContent = currentChapter;
        currentVerbs = [...bibleData[ch]];
        wrongAnswers = [];
        isProcessing = false;
        updateStatus();
        nextQuestion();
    }

    function updateStatus() {
        scoreDisp.textContent = score;
        remainDisp.textContent = currentVerbs.length;
        hintBtnEl.style.display = score >= 5 ? "inline-block" : "none";
        wrongDiv.innerHTML = wrongAnswers.length === 0 
            ? "ì—†ìŒ" 
            : wrongAnswers.map(w => `<span class='wrong-item'>${w.form}</span>`).join("");
    }

    function startTimer() {
        clearInterval(timer);
        timeLeft = 10;
        timeDisp.textContent = timeLeft;
        timer = setInterval(() => {
            timeLeft--;
            timeDisp.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                handleWrong("TIME OVER! -2P");
            }
        }, 1000);
    }

    function nextQuestion() {
        if (currentVerbs.length === 0 && wrongAnswers.length === 0) {
            clearInterval(timer);
            canvas.innerHTML = "<span style='color:#FFD700;'>STAGE CLEAR!</span>";
            const next = currentChapter + 1;
            if (bibleData[next] && !unlockedStages.includes(next)) {
                unlockedStages.push(next);
                saveUnlock();
                updateDropdown();
            }
            return;
        }

        isProcessing = false;
        canvas.className = "";
        
        // ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ì™€ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ í†µí•© ì¶”ì¶œ
        let pool = currentVerbs.length > 0 ? currentVerbs : wrongAnswers;
        current = pool[Math.floor(Math.random() * pool.length)];

        canvas.textContent = current.form;
        input.value = "";
        input.focus();
        feedbackEl.innerHTML = "";
        startTimer();
    }

    function checkAnswer() {
        if (isProcessing || !current) return;
        const val = input.value.trim();

        if (val === current.root) { // .includesë³´ë‹¤ ì •í™•í•œ ë§¤ì¹­ ê¶Œì¥
            isProcessing = true;
            clearInterval(timer);
            score += 10;
            canvas.className = "correct";
            feedbackEl.innerHTML = "<span style='color:lightgreen;'>ì •ë‹µ! +10P</span>";
            
            // ë°ì´í„° ì œê±°
            currentVerbs = currentVerbs.filter(v => v.form !== current.form);
            wrongAnswers = wrongAnswers.filter(v => v.form !== current.form);
            
            updateStatus();
            setTimeout(nextQuestion, 1000);
        } else {
            handleWrong("ì˜¤ë‹µ! -2P");
        }
    }

    function handleWrong(msg) {
        isProcessing = true;
        clearInterval(timer);
        score -= 2;
        canvas.className = "wrong";
        feedbackEl.innerHTML = `<span style='color:red;'>${msg}</span><br>ì •ë‹µ: ${current.root}`;

        if (!wrongAnswers.find(v => v.form === current.form)) {
            wrongAnswers.push(current);
        }

        if (score < 0) {
            alert("GAME OVER! ì ìˆ˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.");
            score = 10;
            loadChapter(currentChapter);
            return;
        }

        updateStatus();
        setTimeout(nextQuestion, 2000);
    }

    function buyHint() {
        if (score < 5) return;
        score -= 5;
        feedbackEl.innerHTML = `<div style='color:#ff9800;'>íŒíŠ¸: ${current.root[0]}...</div>`;
        updateStatus();
        input.focus();
    }

    function goStudy() {
        location.href = "study.html?ch=" + currentChapter;
    }

    chapterSelect.onchange = (e) => loadChapter(e.target.value);
    input.onkeypress = (e) => { if (e.key === "Enter") checkAnswer(); };

    window.onload = () => {
        updateDropdown();
        loadChapter(1);
    };
</script>
</body>
</html>
